---
- name: Add nats helm support
  hosts: localhost
  connection: local
  vars:
    k8s_resc_co_dir: ./k8s-resources
    k8s_resc_sub_dir: resources/addons
    ns: nats
    nats_cmd_pod: nats-box
  tasks:
    - name: Add nats helm repository
      environment:
        KUBECONFIG: "{{ lookup('env', 'KUBECONFIG') }}"
      kubernetes.core.helm_repository:
        name: nats
        repo_url: https://nats-io.github.io/k8s/helm/charts/
        state: present

    - name: set resc_dir
      set_fact:
        resc_dir: "{{ k8s_resc_co_dir }}/{{ k8s_resc_sub_dir }}"

    - name: Create nats namespace
      environment:
        KUBECONFIG: "{{ lookup('env', 'KUBECONFIG') }}"
      kubernetes.core.k8s:
        name: "{{ ns }}"
        state: present
        kind: namespace
        api_version: v1

    - name: Install nats helm chart
      environment:
        KUBECONFIG: "{{ lookup('env', 'KUBECONFIG') }}"
      kubernetes.core.helm:
        name: nats
        chart_ref: nats/nats
        release_namespace: "{{ ns }}"
        wait: true
        values_files:
          - "{{ resc_dir }}/nats/values.yaml"

    - name: run the nsc-init.sh bash script with the namespace as an argument
      ansible.builtin.command: "bash files/nsc-init.sh {{ ns }}"
      environment:
        KUBECONFIG: "{{ lookup('env', 'KUBECONFIG') }}"

    - name: get the name of the nats-box pod
      environment:
        KUBECONFIG: "{{ lookup('env', 'KUBECONFIG') }}"
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ ns }}"
        label_selectors:
          - app.kubernetes.io/name=nats
          - app.kubernetes.io/instance=nats
          - app.kubernetes.io/component=nats-box
      register: nats_box_pod

    - name: create a download temp directory locally.
      ansible.builtin.tempfile:
        state: directory
        suffix: -downloads
      register: download_dir

    - name: copy the services.creds file from the nats-box pod to the local machine
      kubernetes.core.k8s_cp:
        pod: "{{ nats_box_pod.resources[0].metadata.name }}"
        remote_path: /nsc/nkeys/creds/cyverse/de/services.creds
        local_path: "{{ download_dir.path }}/services.creds"
        namespace: "{{ ns }}"
        state: from_pod

    - name: create a secret named nats-services-creds containing the services.creds file
      environment:
        KUBECONFIG: "{{ lookup('env', 'KUBECONFIG') }}"
      kubernetes.core.k8s:
        name: nats-services-creds
        namespace: "{{ ns }}"
        state: present
        definition:
          kind: secret
          api_version: v1
          type: Opaque
          data:
            services.creds: "{{ lookup('pipe', 'base64 ' + download_dir.path + '/services.creds') }}"

    - name: delete the download directory
      ansible.builtin.file:
        path: "{{ download_dir.path }}"
        state: absent
