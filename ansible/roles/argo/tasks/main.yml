---
- delegate_to: localhost
  environment:
    KUBECONFIG: "{{ lookup('env', 'KUBECONFIG') }}"
  block:
    - name: create the argo namespace
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: argo

    - name: install argo
      kubernetes.core.k8s:
        state: present
        src: install.yaml

    - name: create argo-executor role
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: rbac.authorization.k8s.io/v1
          kind: Role
          metadata:
            name: argo-executor
            namespace: argo
          rules:
            - apiGroups:
                - argoproj.io
              resources:
                - workflowtaskresults
              verbs:
                - create
                - patch

    - name: create the argo-executor service account
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ServiceAccount
          metadata:
            name: argo-executor
            namespace: argo

    - name: create the argo-executor role-binding
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: RoleBinding
          metadata:
            name: argo-executor-binding
            namespace: argo
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: Role
            name: argo-executor
            namespace: argo
          subjects:
            - kind: ServiceAccount
              name: argo-executor
              namespace: argo
